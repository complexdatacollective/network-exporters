!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,o)}return r}function t(t){for(var o=1;o<arguments.length;o++){var i=null!=arguments[o]?arguments[o]:{};o%2?e(Object(i),!0).forEach((function(e){r(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):e(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var{merge:o,isEmpty:i,groupBy:s}=require("lodash"),n=require("sanitize-filename"),{EventEmitter:a}=require("eventemitter3"),p=require("async/queue"),{protocolProperty:c}=require("./consts/reservedAttributes"),{removeDirectory:h,makeTempDir:l}=require("./utils/filesystem"),u=require("./exportFile"),{insertEgoIntoSessionNetworks:d,resequenceIds:y,partitionNetworkByType:g,unionOfNetworks:f}=require("./formatters/network"),{verifySessionVariables:m,getFilePrefix:b,sleep:w,handlePlatformSaveDialog:x,ObservableValue:v}=require("./utils/general"),O=require("./utils/archive"),{ExportError:P,ErrorMessages:E}=require("./errors/ExportError"),k=require("./ProgressMessages"),S=require("./errors/UserCancelledExport"),{isElectron:C}=require("./utils/Environment"),D={adjacencyMatrix:!1,attributeList:!0,edgeList:!0,egoAttributeList:!0},I={exportGraphML:!0,exportCSV:D,globalOptions:{exportFilename:"networkCanvasExport",unifyNetworks:!1,useDirectedEdges:!1,useScreenLayoutCoordinates:!0,screenLayoutHeight:1080,screenLayoutWidth:1920}};module.exports=class{constructor(){var e=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r(this,"on",(function(){e.events.on(...arguments)})),r(this,"removeAllListeners",(()=>{this.events.removeAllListeners()})),this.exportOptions=(e=>t(t({},o(I,e)),!0===e.exportCSV?{exportCSV:D}:{}))(i),this.events=new a}emit(e,t){e?this.events.emit(e,t):console.warn("Malformed emit.")}exportSessions(e,t){var r,o=C()?50:1,a=p(((e,t)=>{e().then((e=>t(null,e))).catch((e=>t(e)))}),o),D=[...this.exportOptions.exportGraphML?["graphml"]:[],...this.exportOptions.exportCSV?["ego"]:[],...this.exportOptions.exportCSV.adjacencyMatrix?["adjacencyMatrix"]:[],...this.exportOptions.exportCSV.attributeList?["attributeList"]:[],...this.exportOptions.exportCSV.edgeList?["edgeList"]:[]],I=()=>{if(a.kill(),r)try{h(r)}catch(e){console.error("Error removing temp directory:",e)}};return this.emit("begin",k.Begin),!e&&!i(e)||!t&&!i(t)?Promise.reject(new P(E.MissingParameters)):new Promise((o=>{var i=!1,p=[],h=[],C=new v(!1),j=()=>!i;o({run:()=>new Promise(((o,v)=>{l().then((e=>{r=e})).then(w(1e3)).then((()=>{if(!j())throw new S})).then((()=>(this.emit("update",k.Formatting),d(e)))).then((e=>y(e))).then((e=>s(e,"sessionVariables.".concat(c)))).then((e=>{if(!j())throw new S;return this.exportOptions.globalOptions.unifyNetworks?(this.emit("update",k.Merging),f(e)):e})).then((o=>{if(!j())throw new S;var i=[],s=[],n=this.exportOptions.globalOptions.unifyNetworks?Object.keys(o).length:e.length;return Object.keys(o).forEach((e=>{if(!t[e]){var a="No protocol was provided for the session. Looked for protocolUID ".concat(e);return this.emit("error",a),void h.push(a)}o[e].forEach((o=>{try{this.exportOptions.globalOptions.unifyNetworks?Object.values(o.sessionVariables).forEach((e=>{m(e)})):m(o.sessionVariables)}catch(e){return void h.push(e)}var a=t[e],p=b(o,a,this.exportOptions.globalOptions.unifyNetworks);D.forEach((e=>{g(a.codebook,o,e).forEach((t=>{var c=t.partitionEntity;i.push((()=>new Promise(((i,h)=>{try{u(p,c,e,r,t,a.codebook,this.exportOptions).then((e=>{s.includes(p)||(this.exportOptions.globalOptions.unifyNetworks?Object.values(o.sessionVariables).forEach((e=>{this.emit("session-exported",e.sessionId)})):this.emit("session-exported",o.sessionVariables.sessionId),this.emit("update",k.ExportSession(s.length+1,n)),s.push(p)),i(e)})).catch((e=>h(e)))}catch(e){this.emit("error","Encoding ".concat(p," failed: ").concat(e.message)),this.emit("update",k.ExportSession(s.length+1,n)),h(e)}}))))}))}))}))})),a.push(i,((e,t)=>{e?h.push(e):p.push(t)})),new Promise(((e,t)=>a.drain().then((()=>e({exportedPaths:p,failedExports:h}))).catch(t)))})).then((e=>{var{exportedPaths:t,failedExports:s}=e;if(!j())throw new S;if(0===t.length&&0===s.length)throw new P(E.NothingToExport);if(0===t.length)return this.emit("finished",k.Finished),I(),o(),i=!0,Promise.resolve();return this.emit("update",k.ZipStart),O(t,r,n(this.exportOptions.globalOptions.exportFilename),(e=>this.emit("update",k.ZipProgress(e))),j)})).then((e=>{if(!j())throw new S;return this.emit("update",k.Saving),e})).then((e=>{if(!j())throw new S;return new Promise(((e,t)=>{var r=r=>{j()||t(),!1===r&&e()};C.registerListener(r),r(C.value)})).then((()=>x(e,n(this.exportOptions.globalOptions.exportFilename))))})).then((e=>{if(!j())throw new S;e||this.emit("finished",k.Finished),I(),o()})).catch((e=>{I(),e instanceof S||(this.emit("cancelled",k.Cancelled),v(e))}))})),abort:()=>{console.info("Aborting file export."),j()?i=!0:console.warn("This export already aborted. Cancelling abort!")},setConsideringAbort:e=>{C.value=e}})}))}};module.exports={caseProperty:"caseId",edgeSourceProperty:"from",edgeTargetProperty:"to",egoProperty:"networkCanvasEgoUUID",entityAttributesProperty:"attributes",entityPrimaryKeyProperty:"_uid",nodeExportIDProperty:"nodeID",edgeExportIDProperty:"edgeID",ncCaseProperty:"networkCanvasCaseID",ncProtocolNameProperty:"networkCanvasProtocolName",ncSessionProperty:"networkCanvasSessionID",ncSourceUUID:"networkCanvasSourceUUID",ncTargetUUID:"networkCanvasTargetUUID",ncTypeProperty:"networkCanvasType",ncUUIDProperty:"networkCanvasUUID",protocolName:"protocolName",protocolProperty:"protocolUID",sessionExportTimeProperty:"sessionExported",sessionFinishTimeProperty:"sessionFinish",sessionProperty:"sessionId",sessionStartTimeProperty:"sessionStart",codebookHashProperty:"codebookHash"}}));
//# sourceMappingURL=network-exporters.min.js.map
